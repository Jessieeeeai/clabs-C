<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片上传测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .upload-container { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .preview-img { width: 100px; height: 100px; object-fit: cover; border: 1px solid #ddd; margin: 10px 0; }
        .btn { padding: 10px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-primary { background: #007bff; color: white; }
        .hidden { display: none; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>图片上传功能测试</h1>
    
    <div class="upload-container">
        <h3>测试上传功能</h3>
        <img id="test-preview" src="/static/images/default-avatar.svg" alt="预览" class="preview-img" />
        <br>
        <input type="file" id="test-upload" accept="image/*" class="hidden" 
               onchange="if(this.files[0]) testUpload(this.files[0])" />
        <button class="btn btn-primary" onclick="document.getElementById('test-upload').click()">
            选择图片上传
        </button>
        <br>
        <input type="url" id="test-url" placeholder="或输入图片URL" 
               oninput="updateTestPreview()" style="width: 300px; padding: 5px; margin: 10px 0;" />
    </div>
    
    <div class="log" id="log">等待操作...</div>
    
    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.textContent = new Date().toLocaleTimeString() + ': ' + message + '\n' + logDiv.textContent;
        }
        
        async function testUpload(file) {
            log('开始上传文件: ' + file.name + ' (大小: ' + file.size + ' 字节)');
            
            if (!file) {
                log('错误: 没有选择文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            log('正在上传到 /api/upload/image...');
            
            try {
                const response = await fetch('/api/upload/image', {
                    method: 'POST',
                    body: formData
                });
                
                log('服务器响应状态: ' + response.status);
                
                const result = await response.json();
                log('服务器响应: ' + JSON.stringify(result));
                
                if (result.success) {
                    const urlInput = document.getElementById('test-url');
                    const previewImg = document.getElementById('test-preview');
                    
                    if (urlInput) urlInput.value = result.data.url;
                    if (previewImg) previewImg.src = result.data.url;
                    
                    log('✅ 上传成功！图片URL: ' + result.data.url);
                    return result.data.url;
                } else {
                    throw new Error(result.message || '上传失败');
                }
            } catch (error) {
                log('❌ 上传失败: ' + error.message);
                console.error('Upload error:', error);
                return null;
            }
        }
        
        function updateTestPreview() {
            const input = document.getElementById('test-url');
            const preview = document.getElementById('test-preview');
            if (input && preview && input.value) {
                preview.src = input.value;
                log('预览图片已更新: ' + input.value);
            }
        }
        
        log('测试页面加载完成');
    </script>
</body>
</html>